trigger:
  - master

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Terraform
    jobs:
      - job: TerraformDeploy
        steps:
          - script: |
              wget -O terraform.zip https://releases.hashicorp.com/terraform/1.9.0/terraform_1.9.0_linux_amd64.zip
              unzip terraform.zip
              sudo mv terraform /usr/local/bin/
              terraform --version
            displayName: 'Install Terraform'

          - task: AzureCLI@2
            displayName: 'Terraform Init'
            inputs:
              azureSubscription: 'Sudhi'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                cd terraform
                terraform init

          - task: AzureCLI@2
            displayName: 'Terraform Plan'
            inputs:
              azureSubscription: 'Sudhi'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                cd terraform
                terraform plan -out=tfplan

          - task: AzureCLI@2
            displayName: 'Terraform Apply'
            inputs:
              azureSubscription: 'Sudhi'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                cd terraform
                terraform apply -auto-approve tfplan

          - script: |
              cd terraform
              terraform output -json > terraform-output.json
            displayName: 'Generate Terraform Output JSON'

          - publish: terraform/terraform-output.json
            artifact: terraform-output
            displayName: 'Publish Terraform Output'

  - stage: Ansible
    dependsOn: Terraform
    jobs:
      - job: AnsibleConfig
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.x'

          - script: |
              pip install ansible
            displayName: 'Install Ansible'

          - script: |
              ansible-playbook -i ansible/inventory ansible/playbook.yml
            displayName: 'Run Ansible Playbook'
